# Модуль 01. Архитектура Линукс

## Комментарии по сделанному

- [заметки для себя](notes.md) --- сразу сохранил как шпоргалки и дальше ориентировался
- использовал `debian:bullseye`, поскольку там есть нужная нам старая версия php
- долго не мог понять, почему:
  - сеть работает (`nc -zv db 3306` с контейнера web к контейнеру db --- успешно)
  - авторизация работает (`mysql -h db -u user -p mydb` с контейнера web к контейнеру db --- успешно)
  - таблица создана (`select * from regions;` с контейнера web при подключении к mysql контейнера db выдаёт ожидаемые мной записи)
  - но при этом записи из базы и даже обработка ошибок подключения на странице не обображаются!
  - выяснил, что **не всякий PHP умеет в MySQL**, добавил в [[Dockerfile]] **php7.4-mysql** (поискал `apt search php | grep mysql`), и **всё заработало корректно** 
- были ещё какие-то баги по мелочи, но они быстро нашлись и не стоят упоминания

## Условия домашнего задания

### ОБЩЕЕ ОПИСАНИЕ ЗАДАНИЯ

Создайте сайт, который выводит таблицу значений на экран. Разверните его с помощью двух докер-контейнеров (сервер и база данных).

### ЧТО НУЖНО ИСПОЛЬЗОВАТЬ ПРИ РЕШЕНИИ:

- образ Apache и PHP 7.4;
- docker-compose;
- образ mysql:5.7;
- скрипт index.php;
- скрипт init.sql для создания базы данных.

### ТРЕБОВАНИЯ К КОНТЕЙНЕРАМ:

- База данных должна содержать минимум одну таблицу c двумя столбцами и тремя записями.
- Структура и наполнение базы данных — на ваше усмотрение.
- Тематика наполняемых данных должна отличаться от приведённых примеров.

### НАВЫКИ, КОТОРЫЕ ВЫ ПРИОБРЕТЁТЕ, РЕШИВ ЗАДАНИЕ:

- создание образа;
- сбор файла docker-compose.yaml с двумя контейнерами;
- создание базы данных;
- связка фронтенд- и бэкенд-частей через докер-контейнеры.

### ЭТАПЫ РЕШЕНИЯ

### ЭТАП 1. СОЗДАНИЕ КОНТЕЙНЕРА («СЕРВЕР»)

- Самостоятельно создайте образ с Apache и PHP 7.4 с вашей фамилией в названии.
- Создайте файл docker-compose.yaml с двумя контейнерами, один из которых использует созданный вами образ. Далее мы будем называть этот контейнер «Сервер» (см. схему контейнеров выше).
- Создайте образ для второго контейнера — публичного образа mysql:5.7. Далее мы будем называть этот контейнер «БД».

### ЭТАП 2. СОЗДАНИЕ ОБРАЗА ДЛЯ ВТОРОГО КОНТЕЙНЕРА («БД»)

Создайте базу данных MySQL и наполните её в контейнере «БД» с помощью файла init.sql. 

#### Пример файла:

```sql
CREATE DATABASE IF NOT EXISTS reg1;
CREATE USER IF NOT EXISTS 'user' @'%' IDENTIFIED BY 'password';
GRANT 
SELECT 
  , 
UPDATE 
  , 
  INSERT ON reg1.* TO 'user' @'%';
FLUSH PRIVILEGES;
USE reg1;
CREATE TABLE IF NOT EXISTS regions (
  region VARCHAR(100) NOT NULL, 
  maincity VARCHAR(50) NOT NULL, 
  population INT (10) NOT NULL
);
INSERT INTO regions (region, maincity, population) 
VALUES 
  (
    'Primorskij kraj', 'Vladivostok', 
    '1845'
  ), 
  (
    'Khabarovskij kraj', 'Khabarovsk', 
    '1291'
  ), 
  (
    'Amurskaja oblast', 'Blagovestchensk', 
    '767'
  );
```

### ЭТАП 3. НАСТРОЙКА ДВУХ КОНТЕЙНЕРОВ В DOCKER-COMPOSE (КОНТЕЙНЕР «БД»)

В docker-compose.yaml для контейнера «БД» укажите следующие параметры:

- Запуск скрипта init.sql при старте контейнера командой —init-file.
- Создайте директорию dbfile в папке с файлом docker-compose и примонтируйте её в контейнер в директорию /var/lib/mysql.
- Примонтируйте написанный вами файл init.sql в контейнер в директорию /data/application/init.sql.
- Пробросьте порт 3306 контейнера на любой порт хостовой машины.

### ЭТАП 4. НАСТРОЙКА ДВУХ КОНТЕЙНЕРОВ В DOCKER-COMPOSE (КОНТЕЙНЕР «СЕРВЕР»)

В docker-compose контейнера «Сервер» укажите следующие параметры:

Пробросьте порт 80 контейнера на любой порт хостовой машины.
Создайте папку src в директории с файлом docker-compose и примонтируйте её в контейнер в директорию /var/www/html.
Внутри папки src создайте файл index.php.
Пример готового файла index.php:

```php
<html lang="en">
  <head>
    <title>Russian Far East Regions</title>
    <link rel="stylesheet" href="style.css" type="text/css" />
  </head>
  <body>
    <h1>Regions</h1>
    <table>
      <tr>
        <th>region</th>
        <th>maincity</th>
        <th>population</th>
      </tr>
      <?php
				$mysqli = new mysqli("database", "user", "password", "reg1");
				$result = $mysqli->query("SELECT * FROM regions"); foreach ($result as $row) {
      echo "
      <tr>
        <td>{$row['region']}</td>
        <td>{$row['maincity']}</td>
        <td>{$row['population']}</td>
      </tr>
      "; } ?>
    </table>
    <?php
			phpinfo();
		?>
  </body>
</html>
```

### ЭТАП 5. ВЫВОД СОДЕРЖИМОГО НА ВЕБ-СТРАНИЦУ

1. Контейнер «Сервер» с помощью скрипта index.php должен выводить содержимое базы данных MySQL контейнера «БД» на веб-страницу. Структура веб-страницы описывается в файле index.php по вашему желанию.
2. На веб-страницу также выводится информация о версии PHP. Пример вывода см. в начале задания.
